permissions:
  contents: read

name: Django CI
env:
  DJANGO_SECRET_KEY: ${{ secrets.SECRET_KEY }}
  SECRET_KEY: ${{ secrets.SECRET_KEY }}
  DJANGO_DEBUG: "TRUE"

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Ensure a test-only SECRET is present for forked PRs where secrets are unavailable.
      - name: Ensure DJANGO_SECRET_KEY present (fallback for fork PRs)
        run: |
          # If DJANGO_SECRET_KEY is empty (e.g. secrets not exposed on fork PR),
          # write a known insecure fallback for tests only.
          if [ -z "${DJANGO_SECRET_KEY:-}" ]; then
            echo "DJANGO_SECRET_KEY=insecure-ci-secret-for-tests-only" >> $GITHUB_ENV
            echo "Used insecure CI fallback for DJANGO_SECRET_KEY"
          else
            echo "DJANGO_SECRET_KEY present (secret provided)"
          fi

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.13

      - name: Set up Poetry
        uses: matrix-org/setup-python-poetry@5bbf6603c5c930615ec8a29f1b5d7d258d905aa4

      - name: Install dependencies
        run: poetry install

      - name: Run Ruff
        run: poetry run ruff check .

      - name: Run djLint
        run: poetry run djlint --check .

      - name: Run Pytest with Coverage
        run: poetry run pytest
